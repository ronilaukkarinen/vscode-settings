import"reflect-metadata";var t,e=(t=function(t){return-1!==(t||"").indexOf("tsdi")||"*"===t},"object"==typeof exports&&"undefined"!=typeof module?t(process.env.DEBUG):"undefined"!=typeof window&&t(window.localStorage.getItem("DEBUG"))),n=function(t){var n=function(t){for(var n=[],o=arguments.length-1;o-- >0;)n[o]=arguments[o+1];if(e)if(t instanceof Error)console.error(t);else{for(var r=[],i=0,a=0,s=t.indexOf("%",a);-1!==s;){switch(r.push(t.substring(a,s)),t.substr(s,2)){case"%o":r.push(n[i++]);break;case"%s":r.push(String(n[i++]))}s=t.indexOf("%",a=s+2)}a<t.length&&r.push(t.substring(a)),console.log.apply(console,r)}};return n.enabled=e,n};function o(t){return Boolean(t.rtti)}function r(t,e){for(var n=-1,o=0,r=t.length;o<r;o++)e(t[o])&&(n=o);return n}function i(t){return"string"==typeof t?{name:t}:t}var a=[],s=[],c=[];function p(t){if(t.options.name&&r(s,function(e){return e.options.name===t.options.name})>-1)throw new Error("Duplicate name '"+t.options.name+"' for known Components.");s.push(t),a.forEach(function(e){return e(t)})}var f=n();function u(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];var n=function(t,e){void 0===e&&(e={}),f("@Component "+t.name);var n=i(e);return p({fn:t,options:n}),Reflect.defineMetadata("component:options",n,t),t};return 1===t.length&&"function"==typeof t[0]?n(t[0],{}):function(e){return n(e,t[0]||{})}}var d=u,h=n();function m(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];var n=function(t,e){h("@Destroy %s#%s",t.constructor.name,e),Reflect.defineMetadata("component:destroy",e,t)};return t.length>0?n(t[0],t[1]):function(t,e){n(t,e)}}var l=m,y=n();function g(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];var n=function(t){var e;y("@External "+t.name),e=t,-1===r(c,function(t){return t===e})&&(c.push(e),a.forEach(function(t){return t(e)}));var n=function(){for(var e=[],n=arguments.length;n--;)e[n]=arguments[n];return t.__tsdi__.configureExternal(e,t)};return n.displayName=t.name,Object.getOwnPropertyNames(t).filter(function(t){return"name"!==t&&"length"!==t&&"caller"!==t&&"callee"!==t&&"arguments"!==t&&!n[t]}).forEach(function(e){return n[e]=t[e]}),n.prototype=t.prototype,n};return t.length>0?n(t[0]):function(t){return n(t)}}var v=g,C=n();function w(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];var n=function(t,e,n){C.enabled&&C('@Factory %s#%s({name: "%s"})',t.constructor.name,e,t[e].name),p({target:t,property:e.toString(),options:n,rtti:Reflect.getMetadata("design:returntype",t,e)})};if(t.length>1)return n(t[0],t[1],{});var o=t[0]||{};return function(t,e){n(t,e,o)}}var M=w,I=n();function j(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];var n=function(t,e){I("@Initialize %s#%s",t.constructor.name,e),Reflect.defineMetadata("component:init",e,t)};return t.length>0?n(t[0],t[1]):function(t,e){n(t,e)}}var E=j,O=n();function b(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];var n=function(t){var e=i(t||{});return void 0===e.lazy&&(e.lazy=!0),e},o=function(t,e,n){O("@Inject "+t.constructor.name+"#"+String(e));var o=Reflect.getMetadata("design:type",t,e),r=Reflect.getMetadata("component:injects",t);r||(r=[],Reflect.defineMetadata("component:injects",r,t)),r.push({target:t,property:e.toString(),options:n,type:o})},r=function(t,e,n,o){O("@Inject "+String(e));var r=Reflect.getMetadata("component:parameters",t);r||(r=[],Reflect.defineMetadata("component:parameters",r,t)),r.push({options:o,index:n,rtti:Reflect.getMetadata("design:paramtypes",t)[n]})};if(!(t.length>1))return function(e,i,a){var s=n(t[0]||{});return void 0===a?o(e,i,s):r(e,i,a,s)};var a=n({});void 0===t[2]?o(t[0],t[1],a):r(t[0],t[1],t[2],a)}var k=b,x=n(),D=function t(){this.autoMock=void 0,this.components=[],this.instances={},this.properties={},this.lifecycleListeners=[],this.scopes={},this.registerComponent({fn:t,options:{}}),this.instances[0]=this};D.prototype.addLifecycleListener=function(t){var e=this;this.lifecycleListeners.push(t),Object.keys(this.instances).forEach(function(t){e.notifyOnCreate(e.instances[parseInt(t,10)])})},D.prototype.notifyOnCreate=function(t){this.lifecycleListeners.forEach(function(e){e.onCreate&&e.onCreate(t)})},D.prototype.notifyOnDestroy=function(t){this.lifecycleListeners.forEach(function(e){e.onDestroy&&e.onDestroy(t)})},D.prototype.addProperty=function(t,e){this.properties[t]=e},D.prototype.close=function(){var t,e,n,i=this;Object.keys(this.instances).forEach(function(t){var e=parseInt(t,10),n=i.components[e];o(n)||i.destroyInstance(e,n)}),this.instances=[],this.listener&&(t=this.listener,n=r(e=a,function(e){return e===t}),a=n>-1?e.slice(0,n).concat(e.slice(n+1)):e,this.listener=void 0)},D.prototype.destroyInstance=function(t,e){var n=this.instances[t];if(n){this.notifyOnDestroy(n);var r=Reflect.getMetadata("component:destroy",o(e)?e.rtti:e.fn.prototype);r&&n[r]&&n[r].call(n),this.instances[t]=void 0}},D.prototype.enableComponentScanner=function(){var t,e=this;this.listener||(this.listener=function(t){"function"==typeof t?t.__tsdi__=e:e.registerComponent(t)},this.listener&&(a.push(t=this.listener),s.forEach(function(e){return t(e)}),c.forEach(function(e){return t(e)})))},D.prototype.enableAutomock=function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];console.warn("#enableAutomock is deprecated and should not be used. Instead use #override."),this.autoMock=t},D.prototype.registerComponent=function(t){var e=this;if(-1===this.components.indexOf(t)&&(t.options.name&&r(this.components,function(e){return e.options.name===t.options.name})>-1&&console.warn("Component with name '"+t.options.name+"' already registered."),x("registerComponent %o",o(t)?t.rtti.name:t.fn.name),this.components.push(t),t.options.eager)){var n=this.components.length-1;setTimeout(function(){e.getOrCreate(t,n)},0)}},D.prototype.register=function(t,e){var n=Reflect.getMetadata("component:options",t)||{};this.registerComponent({fn:t,options:Object.assign({},n,{name:e||n.name})})},D.prototype.getComponentMetadataIndex=function(t,e){for(var n=0,o=this.components.length;n<o;n++)if(e){if(e===this.components[n].options.name)return n}else if(this.isComponentMetadataIndexFromComponentOrFactory(t,this.components[n]))return n;return-1},D.prototype.isComponentMetadataIndexFromComponentOrFactory=function(t,e){return void 0!==t&&(e.fn===t||o(e)&&e.rtti===t)},D.prototype.throwComponentNotFoundError=function(t,e,n){throw t&&!e&&(e=t.name),e||(e="unknown"),new Error("Component '"+e+"' not found"+(n?": "+n:""))},D.prototype.getConstructorParameters=function(t){var e=this,n=Reflect.getMetadata("component:parameters",t.fn);return n?n.sort(function(t,e){return t.index-e.index}).map(function(t){return{index:e.getComponentMetadataIndex(t.rtti,t.options.name)}}).map(function(t){var n=t.index;return e.getOrCreate(e.components[n],n)}):[]},D.prototype.isSingleton=function(t){return void 0===t.options.singleton||t.options.singleton},D.prototype.getOrCreate=function(t,e){x("> getOrCreate %o",t);var n=this.instances[e];return n&&this.isSingleton(t)||(o(t)?(x("create %o from factory with %o",t.rtti.name,t.options),n=this.get(t.target.constructor)[t.property](),this.instances[e]=n):n=this.createComponent(t,e),this.notifyOnCreate(n)),x("< getOrCreate %o -> %o",t,n),n},D.prototype.createComponent=function(t,e){this.hasEnteredScope(t)||this.throwComponentNotFoundError(t.fn,void 0,"required scope '"+t.options.scope+"' is not enabled"),x("create %o with %o",t.fn.name,t.options);var n=t.fn,o=this.getConstructorParameters(t),r=new(Function.prototype.bind.apply(n,[null].concat(o)));this.instances[e]=r,this.injectIntoInstance(r,!1,t);var i=Reflect.getMetadata("component:init",t.fn.prototype);return i&&r[i].call(r),r},D.prototype.hasEnteredScope=function(t){return!t.options.scope||Boolean(t.options.scope&&this.scopes[t.options.scope])},D.prototype.configureExternal=function(t,e){var n=this.getConstructorParameters({fn:e,options:{}}),o=new(Function.prototype.bind.apply(e,[null].concat(t,n)));this.injectIntoInstance(o,!0,{fn:e,options:{}});var r=Reflect.getMetadata("component:init",e.prototype);return r&&o[r].call(o),o},D.prototype.injectIntoInstance=function(t,e,n){var o=Reflect.getMetadata("component:injects",n.fn.prototype);if(o)for(var r=0,i=o;r<i.length;r+=1){var a=i[r];x("injecting %s.%s",t.constructor.name,a.property),a.options.name&&void 0!==this.properties[a.options.name]?t[a.property]=this.properties[a.options.name]:this.injectDependency(t,e,a,n)}},D.prototype.injectDependency=function(t,e,n,o){if(!this.injectAutoMock(t,n))if(n.options.lazy||n.options.dynamic){var r=this;Object.defineProperty(t,n.property,{configurable:!0,enumerable:!0,get:function(){x("lazy-resolve injected property %s.%s",t.constructor.name,n.property);var i=r.getComponentDependency(n,o,e);return n.options.dynamic?i:(Object.defineProperty(t,n.property,{enumerable:!0,value:i}),x("lazy-resolved injected property %s.%s <- %o",t.constructor.name,n.property,t[n.property]),t[n.property])}})}else t[n.property]=this.getComponentDependency(n,o,e)},D.prototype.injectAutoMock=function(t,e){if(!this.autoMock)return!1;var n=this.getInjectComponentMetadata(e)[0];if(n){var r=o(n)?n.rtti:n.fn;if(this.autoMock.indexOf(r)>-1)return!1;var i=this.mock(r);if(i)return t[e.property]=i,!0}return!1},D.prototype.createAutoMock=function(t){if(this.autoMock&&!(this.autoMock.indexOf(t)>-1)){var e={__tsdi__mock__:"This is a TSDI automock"},n=t.prototype;return Object.getOwnPropertyNames(n).forEach(function(t){"function"==typeof n[t]&&(e[t]=function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];return t})}),e||void 0}},D.prototype.mock=function(t){console.warn("#mock is deprecated and should not be used. Instead use #override.");var e=this.getComponentMetadataIndex(t);if(!this.instances[e]){var n=this.createAutoMock(t);if(!n)throw new Error("Failed to create mock from "+t.name);this.instances[e]=n}return this.instances[e]},D.prototype.getInjectComponentMetadata=function(t){var e=this.getComponentMetadataIndex(t.type,t.options.name);-1===e&&(this.checkAndThrowDependencyError(t),e=this.getComponentMetadataIndex(t.type,t.type.name));var n=this.components[e];if(!n)throw new Error("Failed to get inject '"+t.options.name+"' for '"+t.target.constructor.name+"#"+t.property+"'");return[n,e]},D.prototype.getComponentDependency=function(t,e,n){var r=this.getInjectComponentMetadata(t),i=r[0],a=r[1];return n||t.options.dynamic||o(i)||!i.options.scope||e.options.scope||console.warn("Component '"+i.fn.name+"' is scoped to '"+i.options.scope+"' and injected into '"+e.fn.name+"' without scope. This could easily lead to stale references. Consider to add the scope '"+i.options.scope+"' to '"+e.fn.name+"' as well or make the inject dynamic."),this.getOrCreate(i,a)},D.prototype.checkAndThrowDependencyError=function(t){if(t.type&&t.options.name){var e=new Error("Injecting undefined type on "+t.target.constructor.name+"#"+t.property+": Component named '"+t.options.name+"' not found");throw x(e),x("Known Components: %o",this.components.map(function(t){return o(t)?t.rtti.name:t.fn.name})),e}if(!t.type||t.options.name){var n=new Error("Injecting undefined type on "+t.target.constructor.name+"#"+t.property+": Probably a cyclic dependency, switch to name based injection");throw x(n),n}},D.prototype.get=function(t,e){var n;"string"==typeof t?(e=t,n=void 0):n=t;var o=this.getComponentMetadataIndex(n,e),r=this.components[o];return r||this.throwComponentNotFoundError(n,e),this.getOrCreate(r,o)},D.prototype.override=function(t,e){var n=this.getComponentMetadataIndex(t);this.instances[n]=e,x("Override %o with %o",t,e)},D.prototype.getScope=function(t){var e=this;return{enter:function(){e.scopes[t]=!0},leave:function(){delete e.scopes[t],e.components.filter(function(e){return!o(e)&&e.options.scope===t}).forEach(function(t){var n=e.getComponentMetadataIndex(o(t)?t.rtti:t.fn);e.destroyInstance(n,t)})}}};export{D as TSDI,d as component,u as Component,l as destroy,m as Destroy,v as external,g as External,M as factory,w as Factory,E as initialize,j as Initialize,k as inject,b as Inject};
//# sourceMappingURL=index.mjs.map
